language: cpp

script: |
  if [[ -n "$DOCKER_TAG" ]]; then
    docker exec bc sh -c "cd $TRAVIS_BUILD_DIR && ./autogen.sh"
    docker exec bc sh -c "cd $TRAVIS_BUILD_DIR && ./configure --prefix=$PWD/_inst"
    docker exec bc sh -c "cd $TRAVIS_BUILD_DIR && make"
    docker exec bc sh -c "cd $TRAVIS_BUILD_DIR && make test"
  else
    ./autogen.sh
    ./configure --prefix=$PWD/_inst
    make
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then make test; fi
  fi

matrix:
  include:
  - os: linux
    sudo: true # for setcap so we can run the tests in chroot.
    dist: precise
  - os: linux
    services: docker
    env: DOCKER_TAG=ubuntu:16.04
  - os: osx
    before_install:
      - brew update
      - brew install lzo docbook2x

before_install: |
   if [[ -n "$DOCKER_TAG" ]]; then
     docker pull ${DOCKER_TAG}
     docker run --name bc -v $TRAVIS_BUILD_DIR:/ -td ${DOCKER_TAG} /bin/bash
   fi


addons:
  apt:
    packages:
    - libcap-ng-dev
    - libcap-ng-utils
    - liblzo2-dev
    - docbook2x
    - realpath
